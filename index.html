<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Us ‚Äî 1 Year ‚ú®</title>
  <meta name="description" content="Happy one year :) open on computer for best results" />
  <style>
    :root{
      --bg:#0f172a;         /* slate-900 */
      --panel:#111827;      /* gray-900 */
      --muted:#94a3b8;      /* slate-400 */
      --text:#e5e7eb;       /* gray-200 */
      --accent:#a78bfa;     /* violet-400 */
      --accent2:#34d399;    /* emerald-400 */
      --rose:#fb7185;       /* rose-400 */
      --gold:#facc15;       /* amber-400 */
      --card:#0b1222;       
      --ring:rgba(167,139,250,.5);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); 
      background: 
        radial-gradient(1200px 600px at 80% -10%, rgba(167,139,250,.20), transparent 60%) no-repeat,
        radial-gradient(900px 400px at 10% -10%, rgba(20,184,166,.15), transparent 60%) no-repeat,
        var(--bg);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      position:sticky; top:0; z-index:20; backdrop-filter:saturate(180%) blur(10px);
      background:linear-gradient(to bottom, rgba(15,23,42,.9), rgba(15,23,42,.6));
      border-bottom:1px solid rgba(255,255,255,.05)
    }
    .wrap{max-width:960px; margin:0 auto; padding:16px}
    .nav{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .brand{display:flex; gap:10px; align-items:center}
    .heart{filter: drop-shadow(0 0 12px rgba(251,113,133,.5));}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:8px 12px; border:1px solid rgba(255,255,255,.08); border-radius:999px; background:rgba(11,18,34,.6)}
    .tab.active{border-color:var(--accent); box-shadow:0 0 0 2px var(--ring) inset}

    main{padding:28px 16px 64px}
    section{display:none}
    section.active{display:block}
    @keyframes fade{from{opacity:.2; transform:translateY(4px)} to{opacity:1; transform:none}}

    /* 2x2 grid: left column = photo (row 1) + main card (row 2); right column = tiles spanning both rows */
    .hero{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "photo right"
        "card  right";
      gap:24px;
      align-items:start;
    }
    .home-photo { grid-area: photo; }
    .home-card  { grid-area: card;  }
    .right-grid { grid-area: right; }
    
    /* Right column = vertical stack of tiles */
    .right-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }
    
    /* Mobile: stack everything vertically */
    @media (max-width:900px){
      .hero{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        grid-template-areas:
          "photo"
          "card"
          "right";
      }
    }

    .card{background:linear-gradient(to bottom right, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:rgba(167,139,250,.12); color:var(--text); cursor:pointer}
    .btn:hover{filter:brightness(1.08)}

    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    .tile{background:linear-gradient(to bottom right, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:16px}
    .tile.nowplaying { grid-column: 1 / -1; }
    
    .timeline{position:relative; margin:16px 0;}
    .timeline:before{content:""; position:absolute; left:14px; top:0; bottom:0; width:2px; background:linear-gradient(var(--accent), transparent)}
    .t-item{position:relative; padding-left:42px; margin:16px 0}
    .t-dot{position:absolute; left:6px; top:6px; width:16px; height:16px; border-radius:50%; background:var(--accent); box-shadow:0 0 0 4px rgba(167,139,250,.2)}

    .surprise-list {
      display: flex;
      flex-direction: column;
      gap: 24px; /* space between surprises */
      align-items: center; /* center them nicely */
    }
    
    .s-card {
      width: 100%;
      max-width: 720px; /* cap so they don't stretch too wide on big screens */
      padding: 24px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(to bottom right, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: 0 8px 28px rgba(0,0,0,.25);
      animation: fade 0.4s ease;
    }
    .tag{padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.15); font-size:12px; opacity:.95}
    .tag.lock{border-color:rgba(250,204,21,.5); color:var(--gold)}
    .tag.open{border-color:rgba(52,211,153,.5); color:var(--accent2)}
    .tag.hidden{border-color:rgba(251,113,133,.5); color:var(--rose)}

    .footer{opacity:.7; font-size:13px; text-align:center; padding-top:24px}
    .settings{position:fixed; right:18px; bottom:18px}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); padding:2px 6px; border-radius:6px; font-size:12px}

    .blurred{filter: blur(5px); pointer-events:none; user-select:none}
    .countdown{font-variant-numeric:tabular-nums}

    
    /* ===== Lock screen overlay ===== */
    #lockscreen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle at 50% 40%, rgba(167,139,250,1), var(--bg));
      z-index: 9999; /* Above everything, but below the gear we position later */
      transition: opacity 500ms ease;
    }
    #lockscreen.hidden { opacity: 0; pointer-events: none; }
    #lockCountdown { font-size: 2rem; letter-spacing: .5px; color: var(--text); font-variant-numeric: tabular-nums; }
    #lockMessage  { margin-top: 10px; color: var(--text); }
    .lock-note    { margin-top: 14px; font-size: 12px; color: var(--text); opacity: .9; }

    /* Keep the gear button above the overlay */
    .settings { position: fixed; right: 18px; bottom: 18px; z-index: 10000; }

    @media (max-width:900px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- Lock screen overlay (only countdown visible until unlock) -->
  <div id="lockscreen">
    <div id="lockCountdown">Loading‚Ä¶</div>
    <div id="lockMessage">‚ú®</div>
  </div>

  <header>
    <div class="wrap nav">
      <div class="brand">
        <svg class="heart" width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 21s-7.5-4.438-9.75-8.25C.75 9.75 3 6 6.75 6 9 6 10.5 7.5 12 9c1.5-1.5 3-3 5.25-3C21 6 23.25 9.75 21.75 12.75 19.5 16.563 12 21 12 21Z" fill="currentColor"/></svg>
        <strong>Us ‚Ä¢ Year One</strong>
      </div>
      <nav class="tabs" id="navTabs">
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="home" class="active">
      <div class="hero">
        <!-- LEFT COLUMN (photo on top, card below) -->
        <img
          class="home-photo"
          src="media/photos/home-page-photo.jpg"
          alt="Us ‚Äî One Year"
          style="width:100%; max-width:420px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.3);"
        >
    
        <div class="card home-card">
          <h1 style="margin:0 0 8px;font-size:34px;line-height:1.1">Hi love ‚Äî happy one year üí´</h1>
          <p style="margin:0 0 16px; color:var(--muted)">
            I made us a little corner of the internet. Explore the note, wander down memory lane, and peek at the surprise box (some gifts unlock over time ‚ú®).
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <a class="btn" href="#/anniversary">Read the 1-year note</a>
            <a class="btn" href="#/memory">Walk memory lane</a>
            <a class="btn" href="#/surprise">Open the surprise box</a>
          </div>
        </div>
    
        <!-- RIGHT COLUMN (tiles stacked) -->
        <div class="grid right-grid">
          <div class="tile">
            <h3 style="margin-top:0">Today</h3>
            <div id="today"></div>
          </div>
    
          <div class="tile">
            <h3 style="margin-top:0">Countdown</h3>
            <div id="aniCountdown" class="countdown"></div>
          </div>
    
          <div class="tile nowplaying">
            <h3 style="margin-top:0">Now Playing</h3>
            <h4 style="color:var(--muted)">note: log in to spotify on browser to get full songs</h4>
            <div id="nowPlaying" style="color:var(--muted)">
              Add a link to a shared playlist or a song here in <span class="kbd">/settings</span>.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ANNIVERSARY NOTE -->
    <section id="anniversary">
      <div class="card">
        <h2 style="margin-top:0">Happy 1 Year Anniversary ‚ù§Ô∏è</h2>
        <p style="color:var(--muted)">Here is a little letter for you, to tell you how much I love you, and how proud I am of everything we've done in our first lap around the sun together</p>
        <div id="noteContent" style="line-height:1.7">
          <p>My sweet Julia,</p>

          <p>Happy one year to us!!!!!!!! Everything in life feels so much more real, and more eternal, since you agreed to be my best friend twelve months ago. It feels more like a 1st birthday, like nothing really existed the way things do now. I‚Äôve never been the type to meticulously sort through what possibilities the future holds, but suddenly you came into my life and the possibilities of the future crystalized into a clear, beautiful, and scenic path for us to walk together.</p>
          
          <p>I am so proud of everything we have accomplished and fought through together. Even though there is so much time and there are many challenges for us to take on, we have demonstrated the ability to grow together, speak each other‚Äôs languages more fluently, and reaffirm our love for each other at every opportunity. Our love just keeps rising to the occasion, and it gives me so much confidence that we are meant to be together.</p>
          
          <p>We‚Äôre just about knee-deep in our toughest challenge yet, and it‚Äôs been hard on both of us, but I hope you feel the same way I do. My love hasn‚Äôt waned for an instant. My constant state of amazement at everything you do has only intensified. As fast as everything is changing, your love has made it feel so much more grounded and manageable. You‚Äôre the one thing that was true long before whatever is happening now and will be true even longer into the future.</p>
          
          <p>I wish I could do more to support you, and sometimes I feel so helpless when I can‚Äôt even hold your hand or be a shoulder to lean on. Each of us being on our own journeys can feel lonely and painful. Sometimes I feel distant from what I am supposed to be doing, paralyzed by the pain of missing out on your life. I‚Äôm only able to push through it because I know that the day will come when I never have to miss anything ever again. I can‚Äôt wait for that day, when I get to be by your side through your best and worst moments. And in the meantime, I know that the second I see you in December everything in the world will feel right again.</p>
          
          <p>Three more weeks in the warmth and bliss of our little pocket universe, where all that matters is you ‚Äî a small, sweet taste of our future together. Some days the sensation of hugging you, kissing you, or holding your hand begins to feel fuzzy in my mind. But when I close my eyes, and clear my thoughts, I can perfectly recall the smallest curves of your body, the shape of every one of your fingers, the warmth of your chest and the cool of your thighs. Truly these are the best feelings in the world to me.</p>
          
          <p>No matter how confusing or hectic things get, I can always take a deep breath and remember them like they are permanently laser etched into the deepest regions of my brain. That goes for everything about you, Julia. If we had better technology, I am sure that traces of you could be found in every single synapse of every single dendrite of every single neuron in my brain. I love you so much, baby. Whatever material humans are ultimately made of, your perfect form is written a thousand times over in that medium, endlessly being precisely reproduced with my every thought, each iteration as alive as I am.</p>
          
          <p>I guess that‚Äôs what keeps me sane these days. I think it would be much harder to go on if you didn‚Äôt manage to impress every fiber of your being on my soul. My point is that I love you, Julia. I love you with as much intensity, clarity, and resolution as I do when you are by my side. That much will not change, aside from growing stronger and better resolved. I know the distance feels insurmountable, but I promise you it is not. You are with me everywhere I go, even if you don‚Äôt know it.</p>
          
          <p>And it‚Äôs not something I decided, or you decided ‚Äî it‚Äôs just the way it is. I was clearly programmed to have a perfectly Julia-shaped region in my memory, and you found me, and filled that space forever. Your presence feels so real to me, and I‚Äôm not even willing to say that materially you aren‚Äôt with me, because that just isn‚Äôt what I‚Äôm experiencing. Whatever part of my brain keeps spitting out the image of you or the sound of your voice when I am trying to focus on whatever the day presents me with, it is clearly the least plastic part of me. So, you are with me everywhere, every second of the day.</p>
          
          <p>I hope you have that too a little bit and feel like I get to come with you on your adventures. I think I‚Äôd be less distraught about missing moments in your life if I knew that some version of me lived inside you and was along for the ride always. And I know I am so grateful that this version of you exists inside me. Until we are together again ‚Äî until I am the me on your shoulder and you are the you on mine ‚Äî that version of you will suffice. It‚Äôs infinitely better than having none of you with me.</p>
          
          <p>I love you, Julia. I am so proud of you, and I know you are on the right course in your life to do the amazing things you were meant to, just one of which is being my partner. I love you. I am here for you, and I know that you are there for me also. Everything I do is in pursuit of a future with you, and nothing else really matters when the only future I want is the one with you. I cannot wait to embrace you again in less than two months.</p>
          
          <p>You are so far past just being beautiful, kind, intelligent, wise, and loving. You are the center of my universe. It is hard to be on the periphery of my own world, but at the same time there is no world I‚Äôd rather live in. Until we are together again for good, I promise that I will not stop loving you and being as present as I possibly can be for everything that you do. My love is yours to keep forever, and I hope I get to have yours for just as long.</p>
          
          <p>I don‚Äôt know how or when to end this letter. I don‚Äôt just feel like I could say this in a thousand different ways, but rather I feel like I must. It‚Äôs a good thing I have time to write you a thousand more letters. I can‚Äôt wait to tell you so many more times, forever, that I love you. Thank you for an amazing year, and for making me the luckiest person in the world.</p>
          
          <p>Love,<br>Jake</p>
        </div>
      </div>
    </section>

    <!-- MEMORY LANE -->
    <section id="memory">
      <div class="card">
        <h2 style="margin-top:0">Memory Lane üì∏</h2>
        <p style="color:var(--muted)">Here is a little picture book for you of some of the wonderful times with spent together. I am so proud of how much we have accomplished and been through together, in such a teeny tiny fraction of the time we are lucky enough to have together.</p>
        <div id="timeline" class="timeline"></div>
      </div>
    </section>

    <!-- SURPRISE BOX -->
    <section id="surprise">
      <div class="card">
        <h2 style="margin-top:0">Surprise Box üéÅ</h2>
        <p style="color:var(--muted)">Some gifts are hidden for now. You‚Äôll see their unlock time and a countdown. When the time arrives, they open automatically. ‚ú®</p>
        <div id="surpriseList" class="surprise-list"></div>
      </div>
    </section>

    <!-- SETTINGS (owner) -->
    <section id="settings">
      <div class="card">
        <h2 style="margin-top:0">Site Settings (Owner)</h2>
        <p style="color:var(--muted)">These settings save to your browser only. Use them to point the site at your live JSON without redeploying.</p>
        <div style="display:grid; gap:12px; max-width:700px">
          <label>Data URL (Gist raw or any CORS-friendly JSON)
            <input id="dataUrl" type="url" placeholder="https://gist.githubusercontent.com/.../raw.json" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1222; color:var(--text)">
          </label>
          <label>Owner Passphrase (to unlock settings link)
            <input id="ownerCode" type="text" placeholder="love2025" style="width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1222; color:var(--text)">
          </label>
          <label>Anniversary (YYYY-MM-DD)
            <input id="anniversaryDate" type="date" style="padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1222; color:var(--text)">
          </label>
          <label class="" style="display:flex; align-items:center; gap:8px">
            <input id="previewUnlocked" type="checkbox"> Preview unlocked site (owner only, this device)
          </label>
          <label>Playlist (optional)
            <input id="playlistUrl" type="url" placeholder="https://open.spotify.com/playlist/5dKa5lizom1L1IeJGPHTSN?si=e85b4ded4bca47a9" style="padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0b1222; color:var(--text)">
          </label>
          <div>
            <button class="btn" id="saveSettings">Save</button>
            <span id="saveStatus" style="margin-left:10px; color:var(--muted)"></span>
          </div>
        </div>
      </div>
    </section>

    <div class="footer">Made with ‚ù§ -- Jake</div>
  </main>

  <div class="settings"><button title="Owner" class="btn" id="ownerBtn">‚öôÔ∏è</button></div>

  <script>
    /********************
     * CONFIG + STORAGE *
     ********************/
    const DEFAULT_OWNER_CODE = 'love2025';
    const STORE_KEY = 'anni.settings.v1';

    // üîí Pin to midnight Oct 19 Sweden time (CEST in 2025 = UTC+02:00)
    // This instant is used everywhere for countdowns/unlock, regardless of device TZ.
    const ANNIV_STHLM_ISO = '2025-10-19T18:00:00+02:00';
    const ANNIV_UTC_MS = Date.parse(ANNIV_STHLM_ISO);

    const defaults = {
      ownerCode: DEFAULT_OWNER_CODE,
      dataUrl: '', // If empty, built-in demo data will be used.
      // Keep UI sensible, but logic below ignores this in favor of ANNIV_STHLM_ISO
      anniversaryDate: '2025-10-19',
      playlistUrl: 'https://open.spotify.com/playlist/5dKa5lizom1L1IeJGPHTSN?si=e85b4ded4bca47a9',
      previewUnlocked: false // NEW: owner preview toggle
    };

    function loadSettings(){
      try{ return {...defaults, ...(JSON.parse(localStorage.getItem(STORE_KEY))||{})}; }
      catch(e){ return {...defaults}; }
    }
    function saveSettings(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }

    let settings = loadSettings();

    /****************
     * NAV / ROUTER *
     ****************/
    const routes = [
      { id:'home', label:'Home', hash:'#/' },
      { id:'anniversary', label:'Anniversary', hash:'#/anniversary' },
      { id:'memory', label:'Memory Lane', hash:'#/memory' },
      { id:'surprise', label:'Surprise Box', hash:'#/surprise' },
      { id:'settings', label:'Settings', hash:'#/settings', owner:true },
    ];

    const nav = document.getElementById('navTabs');
    routes.filter(r=>!r.owner).forEach(r=>{
      const a = document.createElement('a'); a.href = r.hash; a.className='tab'; a.textContent=r.label; a.dataset.target=r.id; nav.appendChild(a);
    });

    function setActive(id){
      document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
      const el = document.getElementById(id); if(el) el.classList.add('active');
      document.querySelectorAll('.tab').forEach(t=>{
        t.classList.toggle('active', t.dataset.target===id);
      });
    }

    function route(){
      const h = location.hash || '#/';
      const match = routes.find(r => h === r.hash);
      setActive(match? match.id : 'home');
    }
    window.addEventListener('hashchange', route); route();

    /*******************
     * UTIL / TIME UTC *
     *******************/
    const TZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const fmt = (d, opts={})=>new Intl.DateTimeFormat(undefined,{dateStyle:'medium', timeStyle: opts.time? 'short': undefined}).format(d);

    function now(){ return new Date(); }
    function parseISO(s){ return new Date(s); }

    function relTime(ms){
      const sec = Math.max(0, Math.floor(ms/1000));
      const d = Math.floor(sec/86400);
      const h = Math.floor((sec%86400)/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return `${String(d).padStart(2,'0')}d ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
    }

    /*******************
     * HOME WIDGETS    *
     *******************/
    const todayEl = document.getElementById('today');
    const aniEl = document.getElementById('aniCountdown');

    function renderHome(){
      const today = now();
      todayEl.textContent = `${fmt(today)} ‚Ä¢ ${TZ}`;

      // Use the fixed Stockholm instant for all devices
      const diff = ANNIV_UTC_MS - Date.now();
      if (diff > 0) {
        aniEl.textContent = `T-${relTime(diff)}`;
      } else {
        const daysSince = Math.ceil((Date.now() - ANNIV_UTC_MS) / 86400000) + 1;
        aniEl.textContent = `Day ${daysSince} since our date ‚ú®`;
      }
    }

    function toSpotifyEmbedUrl(url) {
      try {
        const u = new URL(url);
        if (u.hostname.includes('open.spotify.com')) {
          // Convert open.spotify.com/{type}/{id} to /embed/{type}/{id}
          const parts = u.pathname.split('/').filter(Boolean); // ["playlist","ID"]
          if (parts.length >= 2) {
            parts.splice(0, 0, 'embed'); // ["embed","playlist","ID"]
            u.pathname = '/' + parts.join('/');
            // Keep time anchor if present (e.g., ?t=30) ‚Äî Spotify uses ?t= seconds
            return u.toString();
          }
        }
      } catch(e) {}
      return null;
    }
    
    function renderNowPlaying() {
      const el = document.getElementById('nowPlaying');
      if (!el) return;
    
      const url = (settings.playlistUrl || '').trim();
      if (!url) {
        el.innerHTML = 'Add a link to a shared playlist or a song in <span class="kbd">/settings</span>.';
        return;
      }
    
      const embed = toSpotifyEmbedUrl(url);
    
      // Choose a compact height for playlists; slightly taller on wide screens
      const wide = window.matchMedia('(min-width: 800px)').matches;
      const height = wide ? 232 : 152; // Spotify accepts ~152+; 232 looks nice on desktop
    
      if (embed) {
        el.innerHTML = `
          <div style="margin:6px 0 10px">
            <a href="${url}" target="_blank" rel="noopener">Open in Spotify ‚Üó</a>
          </div>
          <iframe
            style="border-radius:12px; width:100%; height:${height}px; border:0; display:block"
            src="${embed}"
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy">
          </iframe>
        `;
      } else {
        el.innerHTML = `<a href="${url}" target="_blank" rel="noopener">Open playlist ‚Üó</a>`;
      }
    }
    window.addEventListener('resize', renderNowPlaying);
    
    setInterval(renderHome, 1000); renderHome(); renderNowPlaying();

    /*******************
     * DATA LOADING    *
     *******************/
    const demoData = {
      note: null,
      memory: [
        {
          date: '2023-08-06',
          title: 'Way back then...',
          text: `
            <p>This might be my favorite photo of us from that time in our lives. I remember how lucky I felt to be by your side, the same feeling I get to this day (okayyyy sometimes I'm only spiritually by your side :( ... )</p>
        
            <img src="media/photos/IMG_1524_Original.jpeg"
                 style="width:100%;max-width:380px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);margin:10px 0">
        
            <p>Can't wait to go surfing together in New Zealand again!!!!! üá≥üáø ‚ù§Ô∏è</p>
          `
        },
        { 
          date: '2023-08-19',
          title: 'Look at us ü•π', 
          text: `
            <p>You look so hot in this and I look like a drunken tool so I had to throw it in here!</p>

            <img src="media/photos/IMG_5339.jpeg"
                 style="width:100%;max-width:380px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);margin:10px 0">
            ` 
        },
        { 
          date: '2023-11-15',
          title: 'I was your "close friend" üò≥', 
          text: `
            <p>Had to screenshot your instagram stories!!! 2023 Jake just so undadulteradly happy that you were taking a picture of him ü•∞</p>

            <div style="
              display:flex;
              gap:10px;
              flex-wrap:wrap;
              justify-content:center;
            ">
              <img src="media/photos/IMG_7717.jpeg"
                   alt="Us on the trail"
                   style="width:48%; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.3);">
              <img src="media/photos/IMG_7718.jpg"
                   alt="View from the overlook"
                   style="width:48%; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.3);">
            </div>
            ` 
        },
        { 
          date: '2024-10-31',
          title: 'Finally together and ballin out!', 
          text: `
            <p>Potentially the first photo taken of us as a couple? I hope you get to celebrate halloween somehow in Sweden. Yay I was concerned and googled it, it is incerasingly popular in Sweden!</p>

            <img src="media/photos/IMG_8859.jpeg"
                 style="width:100%;max-width:380px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);margin:10px 0">
            ` 
        },
        { 
          date: '2024-11-02',
          title: 'Beach Day üèùÔ∏èüåä‚òÄÔ∏è', 
          text: `
            <p>Our first beach day!!! (as a couple)</p>
            
            <p>You didn't have to tell me all about your love of beaches for me to know you were in your element! I'm glad you told me about it anyways. I'd be a happy man if only I could just listen to your beautiful voice talk about the beach forever.</p>

            <img src="media/photos/IMG_8868.jpeg"
                 style="width:100%;max-width:380px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);margin:10px 0">

            <p>Being in your presence truly transforms me into the best version of myself that I've ever known. These are the moments that are worth living for. If I got to pick which day of my life I live every morning, I would pick day at the beach with you every time.</p>

            <img src="media/photos/IMG_8877.jpeg"
                 style="width:100%;max-width:380px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);margin:10px 0">
            ` 
        },
        { 
          date: '2024-11-09',
          title: 'üå∂Ô∏èüî•‚òÑÔ∏è', 
          text: `
            <p>Me absolutely dominating the hottest girlfriend on the planet competition. What else even is there to say?</p>

            <img src="media/photos/IMG_8909.jpeg"
                 style="width:100%;max-width:380px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);margin:10px 0">
            ` 
        },
        { 
          date: '2024-11-09',
          title: 'Two little monkeys!', 
          text: `
            <p>First time climbing together!! I wish we did this more while we still could üò¢ Maybe you'll take me when I'm in Sweden!</p>

            <img src="media/photos/IMG_9417.jpeg"
                 style="width:100%;max-width:380px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.3);margin:10px 0">
            ` 
        },
        {
          date: '2024-12-07',
          title: 'Goodbye for winter break üò¢',
          text: `
            <p>This was such a lovely adventure!! You taught me some good ice skating moves and frolicked on the dance floor like the beautiful ice princess you are:)))</p>

            <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
              <video controls playsinline preload="metadata"
                     style="width:48%;min-width:240px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.3)">
                <source src="media/videos/IMG_9067.MOV">
              <video controls playsinline preload="metadata"
                     style="width:48%;min-width:240px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.3)">
                <source src="media/videos/IMG_9065.MOV">
              </video>
            </div>
          `    
        }
      ],
      surprises: [
        { 
          id:'g1', 
          status:'announced', 
          title:'A poem for you', 
          text:
            `
              <div style="white-space:pre-wrap; line-height:1.6">
                <strong>What Space Faith Can Occupy</strong><br><em>by TC Tolbert</em>
                
                I believe that witness is a magnitude of vulnerability.
                That when I say love what I mean is not a feeling
                nor promise of a feeling. I believe in attention.
                My love for you is a monolith of try.
                
                The woman I love pays an inordinate amount
                of attention to large and small objects. She is not
                described by anything. Because I could not mean anything else,
                she knows exactly what I mean.
                
                Once upon a time a line saw itself
                clear to its end. I have seen the shape
                of happiness. (y=mx+b)
                I am holding it. It is your hand.
              </div>
            `, 
          url:'', 
          image:'', 
          unlock_at:'2025-10-18T16:00:00-07:00' },
        { id:'g2', status:'hidden', title:'Mystery drop', text:'You‚Äôll see what it is when it unlocks.', url:'', image:'', unlock_at:'2025-10-25T09:00:00-07:00' },
        { id:'g3', status:'announced', title:'Virtual picnic kit', text:'Recipes + playlist', url:'', image:'', unlock_at:'2025-11-01T10:00:00-07:00' }
      ]
    };

    async function fetchData(){
      if(!settings.dataUrl){ return structuredClone(demoData); }
      try{
        const res = await fetch(settings.dataUrl + `?t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw new Error('Fetch failed');
        return await res.json();
      }catch(e){ console.warn('Falling back to demo data', e); return structuredClone(demoData); }
    }

    /*******************
     * MEMORY LANE     *
     *******************/
    function renderTimeline(items){
      const wrap = document.getElementById('timeline');
      wrap.innerHTML = '';
      const sorted = [...items].sort((a,b)=> a.date.localeCompare(b.date));
      sorted.forEach(it=>{
        const d = document.createElement('div'); d.className='t-item card';
        d.innerHTML = `<div class="t-dot"></div>
          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap">
            <strong>${fmt(parseISO(it.date+'T00:00:00'))}</strong>
            <span style="opacity:.8">${it.title||''}</span>
          </div>
          <div style="color:var(--muted); margin-top:8px">${it.text||''}</div>`;
        wrap.appendChild(d);
      });
    }

    /*******************
     * SURPRISE BOX    *
     *******************/
    function statusTag(status, open){
      if(open) return `<span class="tag open">Available</span>`;
      if(status==='hidden') return `<span class="tag hidden">Hidden</span>`;
      return `<span class="tag lock">Locked</span>`;
    }

    function surpriseCard(item){
      const nowMs = now().getTime();
      const unlockMs = new Date(item.unlock_at).getTime();
      const isOpen = nowMs >= unlockMs;
      const timeLeft = unlockMs - nowMs;
      const showText = isOpen || item.status !== 'hidden';
      const title = showText ? item.title : 'Mystery gift';
      const text = showText ? (item.text||'') : 'Opens soon üíå';
      const blur = !isOpen && item.status==='hidden' ? 'blurred' : '';

      return `<div class="s-card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px">
          <strong>${title}</strong>
          ${statusTag(item.status, isOpen)}
        </div>
        <div class="${blur}" style="color:var(--muted); min-height:40px">${text}</div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px">
          <small style="opacity:.8">Unlocks: ${fmt(new Date(item.unlock_at),{time:true})}</small>
          ${!isOpen ? `<small class="countdown" data-unlock="${unlockMs}">${relTime(timeLeft)}</small>` : (item.url? `<a class="btn" href="${item.url}" target="_blank" rel="noopener">Open</a>`: '<span class="tag open">Enjoy ‚ú®</span>')}
        </div>
      </div>`;
    }

    function tickCountdowns(){
      document.querySelectorAll('[data-unlock]').forEach(el=>{
        const t = parseInt(el.getAttribute('data-unlock'),10) - now().getTime();
        el.textContent = relTime(t);
      })
    }
    setInterval(tickCountdowns, 1000);

    async function renderAll(){
      const data = await fetchData();
      // Note content
      if(data.note){ document.getElementById('noteContent').innerHTML = data.note; }
      // Timeline
      renderTimeline(Array.isArray(data.memory)? data.memory : []);
      // Surprises
      const list = document.getElementById('surpriseList');
      const items = Array.isArray(data.surprises)? data.surprises : [];
      // sort: earliest unlock first
      items.sort((a,b)=> new Date(a.unlock_at) - new Date(b.unlock_at));
      list.innerHTML = items.map(surpriseCard).join('');
    }

    renderAll();

    /*******************
     * OWNER CONTROLS  *
     *******************/
    const ownerBtn = document.getElementById('ownerBtn');

    ownerBtn.addEventListener('click', ()=>{
      const code = prompt('Owner passphrase?');
      if(code && code === settings.ownerCode){  
        settings.previewUnlocked = true;
        saveSettings(settings);
        updateLockState();            // hide overlay immediately
        location.hash = '#/settings'; // then navigate
      }
      else alert('Wrong code');
    });

    // Settings page bindings
    const dataUrlI = document.getElementById('dataUrl');
    const ownerCodeI = document.getElementById('ownerCode');
    const annivI = document.getElementById('anniversaryDate');
    const playlistI = document.getElementById('playlistUrl');
    const previewI = document.getElementById('previewUnlocked');
    const saveBtn = document.getElementById('saveSettings');
    const saveStatus = document.getElementById('saveStatus');

    function loadSettingsIntoForm(){
      dataUrlI.value = settings.dataUrl || '';
      ownerCodeI.value = settings.ownerCode || DEFAULT_OWNER_CODE;
      annivI.value = settings.anniversaryDate || defaults.anniversaryDate;
      playlistI.value = settings.playlistUrl || '';
      previewI.checked = !!settings.previewUnlocked;
    }
    loadSettingsIntoForm();

    saveBtn.addEventListener('click', ()=>{
      settings = {
        ...settings,
        dataUrl: dataUrlI.value.trim(),
        ownerCode: ownerCodeI.value.trim() || DEFAULT_OWNER_CODE,
        anniversaryDate: annivI.value || defaults.anniversaryDate, // UI only; logic uses ANNIV_STHLM_ISO
        playlistUrl: playlistI.value.trim(),
        previewUnlocked: !!previewI.checked
      };
      saveSettings(settings);
      saveStatus.textContent = 'Saved!';
      setTimeout(()=> saveStatus.textContent='', 1500);
      renderHome();
      updateLockState();
      renderAll();
      renderNowPlaying();
    });

    // Keyboard: press "o" to open settings prompt
    document.addEventListener('keydown', (e)=>{
      if((e.key==='o' || e.key==='O') && (e.ctrlKey || e.metaKey)){
        ownerBtn.click();
      }
    });

    /***********************
     * GLOBAL UNLOCK LOGIC *
     ***********************/
    const lockEl = document.getElementById('lockscreen');
    const lockCountdownEl = document.getElementById('lockCountdown');

    function isUnlockTime(){
      // Compare device time to the fixed Stockholm instant
      return Date.now() >= ANNIV_UTC_MS || !!settings.previewUnlocked;
    }

    function updateLockCountdown(){
      const diff = ANNIV_UTC_MS - Date.now();
      lockCountdownEl.innerHTML = diff <= 0
        ? 'Unlocked!'
        : `One year. Fifty Weeks.<br>500 Million Miles<br>Just the Beginning<br><br>Unlocks on our anniversary: ${relTime(diff)}`;
    }

    function updateLockState(){
      const unlocked = settings.previewUnlocked || isUnlockTime();
      if(unlocked){
        lockEl.classList.add('hidden');
      }else{
        lockEl.classList.remove('hidden');
      }
    }

    setInterval(()=>{ updateLockCountdown(); updateLockState(); }, 1000);
    // Initial state on load
    updateLockCountdown();
    updateLockState();

  </script>
</body>
</html>
